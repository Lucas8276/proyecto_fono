<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Listado de Pacientes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background: #f4fafd; font-family: Arial, sans-serif; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 6px 24px rgba(80,196,237,0.10); padding: 32px 24px; }
    h1 { color: #4681A1; text-align: center; margin-bottom: 28px; }
    table { width: 100%; margin-top: 18px; }
    th, td { text-align: center; vertical-align: middle; }
    th { background: #50C4ED; color: #fff; }
    tr:nth-child(even) { background: #f8fcff; }
    tr:hover { background: #e6f7ff; }
    @media (max-width: 600px) {
      .container { box-shadow:none; background:transparent; border-radius:0; max-width:100vw; padding:0; margin:0; }
      #loginRegisterSelector, #loginContainer, #registerContainer { box-shadow:none !important; background:transparent !important; border-radius:0 !important; max-width:100vw !important; padding:0 !important; margin:0 !important; }
      h1, h2, h3 { font-size: 1.1rem !important; }
      table { font-size: 0.92rem; }
      .btn { font-size: 0.98rem !important; padding: 8px 10px !important; }
      img { max-width: 90vw !important; height: auto !important; }
    }
    @media (max-width: 400px) {
      .container { padding: 8px 2vw; }
      table { font-size: 0.85rem; }
    }
  </style>
</head>
<body style="background: linear-gradient(135deg, #e0f7fa 0%, #f4fafd 100%); min-height:100vh;">
<div class="container" id="loginRegisterSelector" style="box-shadow:0 8px 32px rgba(80,196,237,0.18);border-radius:24px;padding:36px 28px;max-width:480px;margin-top:48px;">
  <div style="display:flex;flex-direction:column;align-items:center;">
    <h1 style="color:#4681A1;text-align:center;margin-bottom:16px;font-weight:700;letter-spacing:1px;">Bienvenido Fonoaudiólogo</h1>
    <img src="loginfono.png" style="max-width:180px;margin-bottom:18px;border-radius:16px;box-shadow:0 2px 12px rgba(80,196,237,0.10);">
  </div>
  <h3 style="color:#4681A1;text-align:center;margin-bottom:18px;font-size:1.18rem;font-weight:500;">¿Qué deseas realizar?</h3>
  <div style="display:flex;justify-content:center;gap:24px;margin-bottom:8px;">
    <button id="showLogin" class="btn btn-primary btn-lg" style="border-radius:12px;padding:10px 28px;font-size:1.1rem;box-shadow:0 2px 8px rgba(80,196,237,0.08);">Iniciar sesión</button>
    <button id="showRegister" class="btn btn-success btn-lg" style="border-radius:12px;padding:10px 28px;font-size:1.1rem;box-shadow:0 2px 8px rgba(80,196,237,0.08);">Registrarse</button>
  </div>
</div>
<div class="container" id="loginContainer" style="display:none;box-shadow:0 8px 32px rgba(80,196,237,0.18);border-radius:24px;padding:36px 28px;max-width:480px;margin-top:48px;">
  <h2 style="color:#4681A1;text-align:center;margin-bottom:18px;font-weight:600;">Login Fonoaudiólogo</h2>
  <form id="loginForm" style="max-width:340px;margin:0 auto;">
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" class="form-control" id="email" required style="border-radius:10px;">
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Contraseña</label>
      <input type="password" class="form-control" id="password" required style="border-radius:10px;">
    </div>
    <button type="submit" class="btn btn-primary w-100" style="border-radius:10px;font-size:1.08rem;">Ingresar</button>
  </form>
</div>
<div class="container" id="registerContainer" style="display:none;box-shadow:0 8px 32px rgba(80,196,237,0.18);border-radius:24px;padding:36px 28px;max-width:480px;margin-top:48px;">
  <h3 style="color:#4681A1;text-align:center;margin-bottom:12px;font-weight:600;">Registro de Fonoaudiólogo</h3>
  <form id="registerForm" style="max-width:340px;margin:0 auto;">
    <div class="mb-3">
      <label for="nombre_fono" class="form-label">Nombre</label>
      <input type="text" class="form-control" id="nombre_fono" required style="border-radius:10px;">
    </div>
    <div class="mb-3">
      <label for="email_reg" class="form-label">Email</label>
      <input type="email" class="form-control" id="email_reg" required style="border-radius:10px;">
    </div>
    <div class="mb-3">
      <label for="password_reg" class="form-label">Contraseña</label>
      <input type="password" class="form-control" id="password_reg" required style="border-radius:10px;">
    </div>
    <button type="submit" class="btn btn-success w-100" style="border-radius:10px;font-size:1.08rem;">Registrarse</button>
  </form>
</div>
<div class="container" id="pacientesContainer" style="display:none;">
  <h1>Registro de Pacientes</h1>
  <table class="table table-bordered table-hover">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>DNI</th>
        <th>Edad</th>
        <th>Ver</th>
      </tr>
    </thead>
    <tbody id="tablaPacientes">
      <tr><td colspan="3">Cargando...</td></tr>
    </tbody>
  </table>
  <div style="text-align:right;margin-top:18px;">
    <button onclick="window.location.href='index.html'" class="btn btn-primary">Volver al inicio</button>
  </div>
</div>
<script>
function cargarPacientes() {
  fetch('http://localhost:3000/pacientes')
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('tablaPacientes');
      tbody.innerHTML = '';
      if (Array.isArray(data) && data.length > 0) {
        data.forEach(p => {
          tbody.innerHTML += `<tr><td>${p.paciente_nombre || ''}</td><td>${p.paciente_dni || ''}</td><td>${p.paciente_edad || ''}</td><td><span style=\"cursor:pointer;\" title=\"Ver paciente\" onclick=\"verJuegosPaciente('${p.paciente_dni}')\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" fill=\"#4681A1\" viewBox=\"0 0 16 16\"><path d=\"M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zm-8 4.5c-3.584 0-6.29-3.13-7.254-4.5C1.71 6.13 4.416 3 8 3s6.29 3.13 7.254 4.5c-.964 1.37-3.67 4.5-7.254 4.5z\"/><path d=\"M8 5.5A2.5 2.5 0 1 0 8 10a2.5 2.5 0 0 0 0-4.5zm0 1A1.5 1.5 0 1 1 8 9a1.5 1.5 0 0 1 0-3z\"/></svg></span></td></tr>`;
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="3">No hay pacientes registrados.</td></tr>';
      }
    })
    .catch(() => {
      document.getElementById('tablaPacientes').innerHTML = '<tr><td colspan="3">Error al cargar los pacientes.</td></tr>';
    });
}
document.getElementById('showLogin').onclick = function() {
  document.getElementById('loginRegisterSelector').style.display = 'none';
  document.getElementById('loginContainer').style.display = '';
};
document.getElementById('showRegister').onclick = function() {
  document.getElementById('loginRegisterSelector').style.display = 'none';
  document.getElementById('registerContainer').style.display = '';
};
document.getElementById('registerForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const nombre_fono = document.getElementById('nombre_fono').value;
  const email = document.getElementById('email_reg').value;
  const password = document.getElementById('password_reg').value;
  fetch('http://localhost:3000/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nombre_fono, email, password })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      Swal.fire({ icon: 'success', title: 'Registro exitoso', text: 'Ahora puedes iniciar sesión.' });
      document.getElementById('registerForm').reset();
      document.getElementById('registerContainer').style.display = 'none';
      document.getElementById('loginContainer').style.display = '';
    } else {
      Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'No se pudo registrar.' });
    }
  })
  .catch(() => {
    Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo conectar al servidor.' });
  });
});
document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  fetch('http://localhost:3000/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('pacientesContainer').style.display = '';
      cargarPacientes();
    } else {
      Swal.fire({ icon: 'error', title: 'Login fallido', text: data.message || 'Credenciales incorrectas.' });
    }
  })
  .catch(() => {
    Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo conectar al servidor.' });
  });
});
</script>
<div class="container" id="juegosPacienteContainer" style="display:none; margin-top:30px;">
  <h2 id="datosPacienteTitulo" style="color:#4681A1;text-align:center;margin-bottom:18px;font-weight:600;"></h2>
  <table class="table table-bordered table-hover">
    <thead>
      <tr>
        <th>Juego</th>
        <th>Resultado</th>
      </tr>
    </thead>
    <tbody id="tablaJuegosPaciente">
    </tbody>
  </table>
  <div style="text-align:right;margin-top:18px;">
    <button onclick="cerrarJuegosPaciente()" class="btn btn-secondary">Cerrar</button>
  </div>
</div>
<script>
function verJuegosPaciente(dni) {
  fetch(`http://localhost:3000/paciente-id?dni=${dni}`)
    .then(res => res.json())
    .then(data => {
      if (data && data.id_paciente) {
        // Obtener datos del paciente para mostrar arriba
        const paciente = obtenerPacientePorDni(dni);
        fetch(`http://localhost:3000/juegos-por-paciente?id_paciente=${data.id_paciente}`)
          .then(res => res.json())
          .then(juegos => {
            document.getElementById('pacientesContainer').style.display = 'none';
            document.getElementById('juegosPacienteContainer').style.display = '';
            // Mostrar datos del paciente
            let datosPaciente = '';
            if (paciente) {
              datosPaciente = `Nombre: <b>${paciente.paciente_nombre}</b> | DNI: <b>${paciente.paciente_dni}</b> | Edad: <b>${paciente.paciente_edad}</b>`;
            }
            document.getElementById('datosPacienteTitulo').innerHTML = datosPaciente;
            // Mostrar juegos
            const tbody = document.getElementById('tablaJuegosPaciente');
            tbody.innerHTML = '';
            if (Array.isArray(juegos) && juegos.length > 0) {
              juegos.forEach(j => {
                tbody.innerHTML += `<tr><td>${j.paciente_juego}</td><td>${j.paciente_resultado}</td></tr>`;
              });
            } else {
              tbody.innerHTML = '<tr><td colspan="2">Este paciente no tiene juegos registrados.</td></tr>';
            }
          })
          .catch(() => {
            Swal.fire({ title: 'Error', text: 'No se pudieron obtener los juegos.', icon: 'error' });
          });
      } else {
        Swal.fire({ title: 'No encontrado', text: 'No se encontró el paciente.', icon: 'warning' });
      }
    })
    .catch(() => {
      Swal.fire({ title: 'Error', text: 'No se pudo consultar el paciente.', icon: 'error' });
    });
}

// Función auxiliar para buscar datos del paciente en la tabla cargada
function obtenerPacientePorDni(dni) {
  const filas = document.querySelectorAll('#tablaPacientes tr');
  for (let i = 0; i < filas.length; i++) {
    const celdas = filas[i].getElementsByTagName('td');
    if (celdas.length > 1 && celdas[1].textContent === dni) {
      return {
        paciente_nombre: celdas[0].textContent,
        paciente_dni: celdas[1].textContent,
        paciente_edad: celdas[2].textContent
      };
    }
  }
  return null;
}

function cerrarJuegosPaciente() {
  document.getElementById('juegosPacienteContainer').style.display = 'none';
  document.getElementById('pacientesContainer').style.display = '';
}
</script>
</body>
</html>