<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FONÉTICA - NIVEL 2</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="../css/fonetica.css" rel="stylesheet">
  <script src="../../js/sound.js"></script>

  <style>
    #avatar-panel * {
      text-transform: uppercase !important;
    }
  </style>
</head>

<body>
  <div class="main-container">
    <div class="instructions">
      COLOCÁ CADA CONSONANTE CON SU POSICIÓN ARTICULATORIA
    </div>

    <div class="game-area">
      <div class="letters-col">
        <div class="letter-tile" draggable="true" data-letter="L">L</div>
        <div class="letter-tile" draggable="true" data-letter="P">P</div>
        <div class="letter-tile" draggable="true" data-letter="M">M</div>
        <div class="letter-tile" draggable="true" data-letter="B">B</div>
        <div class="letter-tile" draggable="true" data-letter="V">V</div>
        <div class="letter-tile" draggable="true" data-letter="Z">Z</div>
      </div>

      <div class="images-col">
        <div class="image-box" data-answer="P"><img src="imagenes/letraP.png" alt="LETRA P" /></div>
        <div class="image-box" data-answer="B"><img src="imagenes/letraB.png" alt="LETRA B" /></div>
        <div class="image-box" data-answer="Z"><img src="imagenes/letraZ.png" alt="LETRA Z" /></div>
        <div class="image-box" data-answer="L"><img src="imagenes/letraL.png" alt="LETRA L" /></div>
      </div>
    </div>
  </div>

  <button id="volver-btn">VOLVER</button>

  <div id="alertBox" class="alert" style="display: none;">
    <span id="alertMessage"></span>
  </div>

  <img id="selected-avatar" src="" alt="Avatar Seleccionado" style="position:absolute;top:40px;left:40px;width:90px;height:90px;border-radius:50%;border:4px solid #00b453;box-shadow:0 2px 10px rgba(0,0,0,0.10);object-fit:cover;background:#fffbe6;z-index:900;display:none;cursor:pointer;">
  
  <div id="avatar-panel" style="display:none;position:fixed;top:0;left:0;height:100vh;width:340px;max-width:90vw;background:#fffbe6;box-shadow:4px 0 24px rgba(0,0,0,0.13);z-index:2000;padding:36px 24px 24px 24px;transition:transform 0.3s cubic-bezier(.4,1.3,.5,1);transform:translateX(-100%);font-family:'Fredoka',sans-serif;">
    <button id="close-panel" style="position:absolute;top:18px;right:18px;background:none;border:none;font-size:2rem;cursor:pointer;color:#00b453;">×</button>
    <div style="display:flex;flex-direction:column;align-items:center;gap:18px;">
      <img id="avatar-panel-img" src="" alt="Avatar Grande" style="width:120px;height:120px;border-radius:50%;border:4px solid #00b453;box-shadow:0 2px 10px rgba(0,0,0,0.10);background:#fff;object-fit:cover;">
      <div style="font-size:1.3rem;color:#00b453;font-weight:bold;">Nombre:</div>
      <div id="panel-nombre" style="font-size:1.5rem;color:#333;margin-bottom:8px;"></div>
      <div style="font-size:1.3rem;color:#00b453;font-weight:bold;">Edad:</div>
      <div id="panel-edad" style="font-size:1.5rem;color:#333;margin-bottom:18px;"></div>
      <button id="sound-btn" style="display:flex;align-items:center;gap:10px;padding:12px 28px;font-size:1.1rem;font-family:'Fredoka',sans-serif;background:#ffd817;color:#333;border:none;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.10);font-weight:bold;cursor:pointer;transition:background 0.2s;">
        <span id="sound-icon">🔊</span> <span id="sound-text">Sonido Activado</span>
      </button>
      <div style="margin-top:24px;font-size:1.2rem;color:#4a94ff;text-align:center;">¡Listo para jugar y aprender!</div>
    </div>
  </div>

  <script>
  function enviarResultadosFonetica(correctMatches, wrongMatches, currentLevel) {
  const id_paciente = localStorage.getItem('id_paciente');
  if (!id_paciente || isNaN(parseInt(id_paciente))) {
    console.error('id_paciente no válido');
    return;
  }

  const data = {
    id_paciente: parseInt(id_paciente),
    paciente_juego: `Fonética - Nivel ${currentLevel}`,
    paciente_resultado: `${correctMatches} aciertos, ${wrongMatches} desaciertos`,
    paciente_acierto: correctMatches,
    paciente_desacierto: wrongMatches
  };

  fetch('http://localhost:3000/juegos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) throw new Error('Error al guardar los resultados');
    return response.text();
  })
  .then(msg => {
    console.log(msg);
    // Redirigir tras guardar resultados
    const nextLevel = currentLevel + 1;
    if (nextLevel <= 3) {
      window.location.href = `fonetica${nextLevel}.html?id_paciente=${id_paciente}`;
    } else {
      window.location.href = `../../index.html?id_paciente=${id_paciente}`;
    }
  })
  .catch(err => {
    console.error(err);
    // Igual redirigir aunque haya error
    const nextLevel = currentLevel + 1;
    if (nextLevel <= 3) {
      window.location.href = `fonetica${nextLevel}.html?id_paciente=${id_paciente}`;
    } else {
      window.location.href = `../../index.html?id_paciente=${id_paciente}`;
    }
  });
}

    document.addEventListener("DOMContentLoaded", function () {
      const letterTiles = document.querySelectorAll(".letter-tile");
      const imageBoxes = document.querySelectorAll(".image-box");
      const alertBox = document.getElementById("alertBox");
      const alertMessage = document.getElementById("alertMessage");
      let correctMatches = 0;
      let wrongMatches = 0; 
      let currentLevel = 2;
      let id_paciente = localStorage.getItem('id_paciente');

      // Función para mostrar alerta
      function showAlert(message, isSuccess) {
        Swal.fire({
          title: message,
          icon: 'none',
          timer: 1500,
          showConfirmButton: false,
          customClass: {
            title: 'emoji-title',
            popup: 'emoji-popup'
          }
        });
      }

      // Función para navegar al siguiente nivel
      function goToNextLevel() {
        const nextLevel = currentLevel + 1;
        if (nextLevel <= 3) {
          setTimeout(() => {
            window.location.href = `fonetica${nextLevel}.html?id_paciente=${id_paciente}`;
          }, 1500);
        } else {
          // Si estamos en el nivel 3, volvemos al index
          setTimeout(() => {
            window.location.href = `../../index.html?id_paciente=${id_paciente}`;
          }, 1500);
        }
      }

      // Función para verificar si se completó el nivel
       function checkLevelCompletion() {
    if (correctMatches === imageBoxes.length) {
      Swal.fire({
        title: '¡NIVEL COMPLETADO!',
        icon: 'none',
        timer: 1500,
        showConfirmButton: false,
        customClass: {
          title: 'level-complete-title',
          popup: 'level-complete-popup'
        }
      }).then(() => {
        enviarResultadosFonetica(correctMatches, wrongMatches, currentLevel);
      });
    }
  }

      // Eventos de arrastre para las letras
      letterTiles.forEach((tile) => {
        tile.setAttribute("draggable", "true");
        
        tile.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", tile.dataset.letter);
          tile.classList.add("dragging");
        });

        tile.addEventListener("dragend", () => {
          tile.classList.remove("dragging");
        });
      });

      // Eventos para las cajas de imágenes
      imageBoxes.forEach((box) => {
        box.addEventListener("dragover", (e) => {
          e.preventDefault();
          box.classList.add("drag-over");
        });

        box.addEventListener("dragleave", () => {
          box.classList.remove("drag-over");
        });

        box.addEventListener("drop", (e) => {
          e.preventDefault();
          box.classList.remove("drag-over");
          const letter = e.dataTransfer.getData("text/plain");
          const correctLetter = box.getAttribute("data-answer");

          console.log("Letra arrastrada:", letter);
          console.log("Letra correcta:", correctLetter);

          if (letter === correctLetter) {
            // Eliminar la letra
            const tile = document.querySelector(
              `.letter-tile[data-letter="${letter}"]`
            );
            if (tile) {
              tile.remove();
            }

            // Eliminar la imagen
            box.remove();

            correctMatches++;
            showAlert("🎉", true);
            checkLevelCompletion();
          } else {
            showAlert("😢", false);
          }
        });
      });

      // Agregar estilos para el emoji y el mensaje de nivel completado
      const style = document.createElement('style');
      style.textContent = `
        .emoji-title {
          font-size: 100px !important;
          line-height: 1 !important;
        }
        .swal2-title {
          padding: 0 !important;
        }
        .emoji-popup {
          background: transparent !important;
          box-shadow: none !important;
        }
        .level-complete-title {
          color: #ff6632 !important;
          font-size: 40px !important;
          text-align: center !important;
        }
        .level-complete-popup {
          background: transparent !important;
          box-shadow: none !important;
        }
      `;
      document.head.appendChild(style);

      const avatar = sessionStorage.getItem('selectedAvatar');
      const avatarImg = document.getElementById('selected-avatar');
      if (avatar) {
        avatarImg.src = avatar;
        avatarImg.style.display = 'block';
      } else {
        window.location.href = '../../avatar.html';
      }
      const volverBtn = document.getElementById('volver-btn');
      volverBtn.onclick = () => window.location.href = '../../index.html';

      // Panel lateral
      const avatarPanel = document.getElementById('avatar-panel');
      const avatarPanelImg = document.getElementById('avatar-panel-img');
      const panelNombre = document.getElementById('panel-nombre');
      const panelEdad = document.getElementById('panel-edad');
      const soundBtn = document.getElementById('sound-btn');
      const soundIcon = document.getElementById('sound-icon');
      const soundText = document.getElementById('sound-text');
      const closePanel = document.getElementById('close-panel');
      avatarImg.onclick = function() {
        avatarPanel.style.display = 'block';
        setTimeout(()=>{avatarPanel.style.transform = 'translateX(0)';},10);
        avatarPanelImg.src = avatarImg.src;
        // SIEMPRE EN MAYÚSCULAS
        const idPaciente = localStorage.getItem('id_paciente');
       if (idPaciente) {
  fetch(`http://localhost:3000/paciente?id_paciente=${idPaciente}`)
    .then(response => response.json())
    .then(data => {
      const nombre = (data.paciente_nombre || 'Sin nombre').toUpperCase();
      const edad = (data.paciente_edad || 'Sin edad').toString().toUpperCase();
      panelNombre.textContent = nombre;
      panelEdad.textContent = edad;
    })
    .catch(err => {
      console.error('Error al obtener datos del paciente:', err);
      panelNombre.textContent = 'Sin nombre';
      panelEdad.textContent = 'Sin edad';
    });
} else {
  panelNombre.textContent = 'SIN NOMBRE';
  panelEdad.textContent = 'SIN EDAD';
}

        // Estado de sonido
        let sonido = sessionStorage.getItem('sonido_activado');
        if(sonido === null) sonido = 'true';
        if(sonido === 'true') {
          soundIcon.textContent = '🔊';
          soundText.textContent = 'Sonido Activado';
          soundBtn.style.background = '#ffd817';
          soundBtn.style.color = '#333';
        } else {
          soundIcon.textContent = '🔇';
          soundText.textContent = 'Sonido Desactivado';
          soundBtn.style.background = '#eee';
          soundBtn.style.color = '#888';
        }
      };
      closePanel.onclick = function() {
        avatarPanel.style.transform = 'translateX(-100%)';
        setTimeout(()=>{avatarPanel.style.display = 'none';},300);
      };
      soundBtn.onclick = function() {
        let sonido = sessionStorage.getItem('sonido_activado');
        if(sonido === null) sonido = 'true';
        if(sonido === 'true') {
          sessionStorage.setItem('sonido_activado','false');
          if(window.globalAudio){window.globalAudio.pause();}
          soundIcon.textContent = '🔇';
          soundText.textContent = 'Sonido Desactivado';
          soundBtn.style.background = '#eee';
          soundBtn.style.color = '#888';
        } else {
          sessionStorage.setItem('sonido_activado','true');
          if(window.globalAudio){window.globalAudio.play();}
          soundIcon.textContent = '🔊';
          soundText.textContent = 'Sonido Activado';
          soundBtn.style.background = '#ffd817';
          soundBtn.style.color = '#333';
        }
      };
      window.addEventListener('click', function(e) {
        if(avatarPanel.style.display==='block' && !avatarPanel.contains(e.target) && e.target!==avatarImg) {
          avatarPanel.style.transform = 'translateX(-100%)';
          setTimeout(()=>{avatarPanel.style.display = 'none';},300);
        }
      });
    });
  </script>
</body>
</html>

