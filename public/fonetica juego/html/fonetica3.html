<!DOCTYPE html>
<html lang="es">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FONÉTICA - NIVEL 3</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="../css/fonetica.css" rel="stylesheet">
  <script src="../../js/sound.js"></script>
  <script src="../../js/loro.js"></script>

  <style>
    #avatar-panel * {
      text-transform: uppercase !important;
    }
  </style>

</head>

<body>
  <div class="main-container">
    <div class="instructions">
      COLOCÁ CADA CONSONANTE CON SU POSICIÓN ARTICULATORIA
    </div>

    <div class="game-area">
      <div class="letters-col">
        <div class="letter-tile" draggable="true" data-letter="CH">CH</div>
        <div class="letter-tile" draggable="true" data-letter="D">D</div>
        <div class="letter-tile" draggable="true" data-letter="Ñ">Ñ</div>
        <div class="letter-tile" draggable="true" data-letter="F">F</div>
        <div class="letter-tile" draggable="true" data-letter="LL">LL</div>
        <div class="letter-tile" draggable="true" data-letter="S">S</div>
        <div class="letter-tile" draggable="true" data-letter="RR">RR</div>
      </div>

      <div class="images-col">
        <div class="image-box" data-answer="Ñ"><img src="imagenes/letraÑ.png" alt="LETRA Ñ" /></div>
        <div class="image-box" data-answer="CH"><img src="imagenes/letraCH.png" alt="LETRA CH" /></div>
        <div class="image-box" data-answer="LL"><img src="imagenes/letraLL.png" alt="LETRA LL" /></div>
        <div class="image-box" data-answer="RR"><img src="imagenes/letraRR.png" alt="LETRA RR" /></div>
      </div>
    </div>
  </div>

  <button id="volver-btn">VOLVER</button>

  <div id="alertBox" class="alert" style="display: none;">
    <span id="alertMessage"></span>
  </div>

  <img id="selected-avatar" src="" alt="Avatar Seleccionado" style="position:absolute;top:40px;left:40px;width:90px;height:90px;border-radius:50%;border:4px solid #00b453;box-shadow:0 2px 10px rgba(0,0,0,0.10);object-fit:cover;background:#fffbe6;z-index:900;display:none;cursor:pointer;">
  <!-- Panel lateral del avatar -->
  <div id="avatar-panel" style="display:none;position:fixed;top:0;left:0;height:100vh;width:340px;max-width:90vw;background:#fffbe6;box-shadow:4px 0 24px rgba(0,0,0,0.13);z-index:2000;padding:36px 24px 24px 24px;transition:transform 0.3s cubic-bezier(.4,1.3,.5,1);transform:translateX(-100%);font-family:'Fredoka',sans-serif;">
    <button id="close-panel" style="position:absolute;top:18px;right:18px;background:none;border:none;font-size:2rem;cursor:pointer;color:#00b453;">×</button>
    <div style="display:flex;flex-direction:column;align-items:center;gap:18px;">
      <img id="avatar-panel-img" src="" alt="Avatar Grande" style="width:120px;height:120px;border-radius:50%;border:4px solid #00b453;box-shadow:0 2px 10px rgba(0,0,0,0.10);background:#fff;object-fit:cover;">
      <div style="font-size:1.3rem;color:#00b453;font-weight:bold;">Nombre:</div>
      <div id="panel-nombre" style="font-size:1.5rem;color:#333;margin-bottom:8px;"></div>
      <div style="font-size:1.3rem;color:#00b453;font-weight:bold;">Edad:</div>
      <div id="panel-edad" style="font-size:1.5rem;color:#333;margin-bottom:18px;"></div>
      <button id="sound-btn" style="display:flex;align-items:center;gap:10px;padding:12px 28px;font-size:1.1rem;font-family:'Fredoka',sans-serif;background:#ffd817;color:#333;border:none;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.10);font-weight:bold;cursor:pointer;transition:background 0.2s;">
        <span id="sound-icon">🔊</span> <span id="sound-text">Sonido Activado</span>
      </button>
      <div style="margin-top:24px;font-size:1.2rem;color:#4a94ff;text-align:center;">¡Listo para jugar y aprender!</div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
  const letterTiles = document.querySelectorAll(".letter-tile");
  const imageBoxes = document.querySelectorAll(".image-box");
  const alertBox = document.getElementById("alertBox");
  const alertMessage = document.getElementById("alertMessage");
  let correctMatches = 0;
  let wrongMatches = 0;
  const currentLevel = 3;
  let id_paciente = localStorage.getItem('id_paciente');
  const juego_nombre = "Fonetica-Nivel 3"; // Cambia esto si el nombre del juego es otro

  // Función para mostrar alerta con emoji
  function showAlert(message, isSuccess) {
    Swal.fire({
      title: message,
      icon: 'none',
      timer: 1500,
      showConfirmButton: false,
      customClass: {
        title: 'emoji-title',
        popup: 'emoji-popup'
      }
    });
  }

  // Función para enviar resultados al backend
  function enviarResultadosFonetica() {
    if (!id_paciente) {
      console.warn("No se encontró id_paciente en localStorage");
      return;
    }

    const data = {
      id_paciente: id_paciente,
      paciente_acierto: correctMatches,
      paciente_desacierto: wrongMatches,
      paciente_resultado: currentLevel,
      paciente_juego: juego_nombre
    };

    fetch('http://localhost:3000/juegos', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) throw new Error('Error en la respuesta del servidor');
      return response.json();
    })
    .then(result => {
      console.log("Resultados guardados:", result);
    })
    .catch(error => {
      console.error("Error al enviar resultados:", error);
    });
  }

  // Función para verificar si terminó el nivel
  function checkLevelCompletion() {
    const totalBoxes = imageBoxes.length;
    if (correctMatches === totalBoxes) {
      Swal.fire({
        title: '¡NIVEL COMPLETADO!',
        icon: 'none',
        timer: 1500,
        showConfirmButton: false,
        customClass: {
          title: 'level-complete-title',
          popup: 'level-complete-popup'
        }
      }).then(() => {
        enviarResultadosFonetica();
        goToNextLevel();
      });
    }
  }

  // Función para ir al index tras completar nivel
  function goToNextLevel() {
    window.location.href = '../../index.html';
  }

  // Configuración de drag & drop para letras
  letterTiles.forEach((tile) => {
    tile.setAttribute("draggable", "true");

    tile.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("text/plain", tile.dataset.letter);
      tile.classList.add("dragging");
    });

    tile.addEventListener("dragend", () => {
      tile.classList.remove("dragging");
    });
  });

  // Eventos para las cajas de imagen (drop)
  imageBoxes.forEach((box) => {
    box.addEventListener("dragover", (e) => {
      e.preventDefault();
      box.classList.add("drag-over");
    });

    box.addEventListener("dragleave", () => {
      box.classList.remove("drag-over");
    });

    box.addEventListener("drop", (e) => {
      e.preventDefault();
      box.classList.remove("drag-over");
      const letter = e.dataTransfer.getData("text/plain");
      const correctLetter = box.getAttribute("data-answer");

      if (letter === correctLetter) {
        const tile = document.querySelector(`.letter-tile[data-letter="${letter}"]`);
        if (tile) {
          tile.remove();
        }
        box.remove();

        correctMatches++;
        showAlert("🎉", true);
        checkLevelCompletion();
      } else {
        wrongMatches++;
        showAlert("😢", false);
      }
    });
  });

  // Insertar estilos para alertas y nivel completado
  const style = document.createElement('style');
  style.textContent = `
    .emoji-title {
      font-size: 100px !important;
      line-height: 1 !important;
    }
    .swal2-title {
      padding: 0 !important;
    }
    .emoji-popup {
      background: transparent !important;
      box-shadow: none !important;
    }
    .level-complete-title {
      color: #ff6632 !important;
      font-size: 40px !important;
      text-align: center !important;
    }
    .level-complete-popup {
      background: transparent !important;
      box-shadow: none !important;
    }
  `;
  document.head.appendChild(style);

  // Código del panel lateral, avatar y sonido (sin cambios)
  const avatar = sessionStorage.getItem('selectedAvatar');
  const avatarImg = document.getElementById('selected-avatar');
  if (avatar) {
    avatarImg.src = avatar;
    avatarImg.style.display = 'block';
  } else {
    window.location.href = '../../avatar.html';
  }
  const volverBtn = document.getElementById('volver-btn');
  volverBtn.onclick = () => window.location.href = '../../index.html';

  const avatarPanel = document.getElementById('avatar-panel');
  const avatarPanelImg = document.getElementById('avatar-panel-img');
  const panelNombre = document.getElementById('panel-nombre');
  const panelEdad = document.getElementById('panel-edad');
  const soundBtn = document.getElementById('sound-btn');
  const soundIcon = document.getElementById('sound-icon');
  const soundText = document.getElementById('sound-text');
  const closePanel = document.getElementById('close-panel');
  avatarImg.onclick = function() {
    avatarPanel.style.display = 'block';
    setTimeout(()=>{avatarPanel.style.transform = 'translateX(0)';},10);
    avatarPanelImg.src = avatarImg.src;
    const idPaciente = localStorage.getItem('id_paciente');
    if (idPaciente) {
  fetch(`http://localhost:3000/paciente?id_paciente=${idPaciente}`)
    .then(response => response.json())
    .then(data => {
      const nombre = (data.paciente_nombre || 'Sin nombre').toUpperCase();
      const edad = (data.paciente_edad || 'Sin edad').toString().toUpperCase();
      panelNombre.textContent = nombre;
      panelEdad.textContent = edad;
    })
    .catch(err => {
      console.error('Error al obtener datos del paciente:', err);
      panelNombre.textContent = 'Sin nombre';
      panelEdad.textContent = 'Sin edad';
    });
} else {
  panelNombre.textContent = 'SIN NOMBRE';
  panelEdad.textContent = 'SIN EDAD';
}

    let sonido = sessionStorage.getItem('sonido_activado');
    if(sonido === null) sonido = 'true';
    if(sonido === 'true') {
      soundIcon.textContent = '🔊';
      soundText.textContent = 'Sonido Activado';
      soundBtn.style.background = '#ffd817';
      soundBtn.style.color = '#333';
    } else {
      soundIcon.textContent = '🔇';
      soundText.textContent = 'Sonido Desactivado';
      soundBtn.style.background = '#eee';
      soundBtn.style.color = '#888';
    }
  };
  closePanel.onclick = function() {
    avatarPanel.style.transform = 'translateX(-100%)';
    setTimeout(()=>{avatarPanel.style.display = 'none';},300);
  };
  soundBtn.onclick = function() {
    let sonido = sessionStorage.getItem('sonido_activado');
    if(sonido === null) sonido = 'true';
    if(sonido === 'true') {
      sessionStorage.setItem('sonido_activado','false');
      if(window.globalAudio){window.globalAudio.pause();}
      soundIcon.textContent = '🔇';
      soundText.textContent = 'Sonido Desactivado';
      soundBtn.style.background = '#eee';
      soundBtn.style.color = '#888';
    } else {
      sessionStorage.setItem('sonido_activado','true');
      if(window.globalAudio){window.globalAudio.play();}
      soundIcon.textContent = '🔊';
      soundText.textContent = 'Sonido Activado';
      soundBtn.style.background = '#ffd817';
      soundBtn.style.color = '#333';
    }
  };
  window.addEventListener('click', function(e) {
    if(avatarPanel.style.display==='block' && !avatarPanel.contains(e.target) && e.target!==avatarImg) {
      avatarPanel.style.transform = 'translateX(-100%)';
      setTimeout(()=>{avatarPanel.style.display = 'none';},300);
    }
  });

  renderLoro({ mensajes: [
    "¡Tú puedes lograrlo!",
    "¡Sigue adelante, lo estás haciendo genial!",
    "¡Cada intento te acerca más a la meta!",
    "¡Eres muy inteligente!",
    "¡No te rindas, campeón!",
    "¡Estoy orgulloso de ti!",
    "¡Aprender es divertido contigo!",
    "¡Sigue así, vas muy bien!",
    "¡Eres un gran explorador!",
    "¡Tus esfuerzos valen oro!"
  ], imagen: '../../images/loro.png' });
});

  </script>
</body>
</html>
