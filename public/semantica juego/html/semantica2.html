<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sem√°ntica - Nivel 2</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="../css/semantica2.css" rel="stylesheet">
  <script src="../../js/sound.js"></script>
  <style>
    #avatar-panel * {
      text-transform: uppercase !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="instructions animate__animated animate__fadeIn">
      <h2>UN√ç CON FLECHAS LAS PALABRAS QUE SIGNIFIQUEN LO MISMO</h2>
    </div>

    <div class="game-layout">
      <div class="words-container animate__animated animate__fadeIn" id="wordsContainer"></div>
    </div>
  </div>

  <img id="selected-avatar" src="" alt="Avatar Seleccionado" style="position:absolute;top:40px;left:40px;width:90px;height:90px;border-radius:50%;border:4px solid #00b453;box-shadow:0 2px 10px rgba(0,0,0,0.10);object-fit:cover;background:#fffbe6;z-index:900;display:none;cursor:pointer;">
  <!-- Panel lateral del avatar -->
  <div id="avatar-panel" style="display:none;position:fixed;top:0;left:0;height:100vh;width:340px;max-width:90vw;background:#fffbe6;box-shadow:4px 0 24px rgba(0,0,0,0.13);z-index:2000;padding:36px 24px 24px 24px;transition:transform 0.3s cubic-bezier(.4,1.3,.5,1);transform:translateX(-100%);font-family:'Fredoka',sans-serif;">
    <button id="close-panel" style="position:absolute;top:18px;right:18px;background:none;border:none;font-size:2rem;cursor:pointer;color:#00b453;">√ó</button>
    <div style="display:flex;flex-direction:column;align-items:center;gap:18px;">
      <img id="avatar-panel-img" src="" alt="Avatar Grande" style="width:120px;height:120px;border-radius:50%;border:4px solid #00b453;box-shadow:0 2px 10px rgba(0,0,0,0.10);background:#fff;object-fit:cover;">
      <div style="font-size:1.3rem;color:#00b453;font-weight:bold;">Nombre:</div>
      <div id="panel-nombre" style="font-size:1.5rem;color:#333;margin-bottom:8px;"></div>
      <div style="font-size:1.3rem;color:#00b453;font-weight:bold;">Edad:</div>
      <div id="panel-edad" style="font-size:1.5rem;color:#333;margin-bottom:18px;"></div>
      <button id="sound-btn" style="display:flex;align-items:center;gap:10px;padding:12px 28px;font-size:1.1rem;font-family:'Fredoka',sans-serif;background:#ffd817;color:#333;border:none;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.10);font-weight:bold;cursor:pointer;transition:background 0.2s;">
        <span id="sound-icon">üîä</span> <span id="sound-text">Sonido Activado</span>
      </button>
      <div style="margin-top:24px;font-size:1.2rem;color:#4a94ff;text-align:center;">¬°Listo para jugar y aprender!</div>
    </div>
  </div>
  <button id="volver-btn" style="position:fixed;top:40px;right:40px;z-index:1000;padding:16px 36px;font-size:1.2rem;font-weight:bold;border:none;border-radius:14px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.10);background:#ffd817;color:#333;font-family:'Fredoka',sans-serif;">VOLVER</button>

  <script>
    const sets = [
      {
        instrucciones: 'UN√ç CON FLECHAS LAS PALABRAS QUE SIGNIFIQUEN LO MISMO',
        pares: [
          { word1: 'BAL√ìN', word2: 'PELOTA' },
          { word1: 'R√ÅPIDO', word2: 'VELOZ' },
          { word1: 'COLEGIO', word2: 'ESCUELA' },
          { word1: 'FR√çO', word2: 'HELADO' }
        ]
      },
      {
        instrucciones: 'UN√ç CON FLECHAS LAS PALABRAS QUE SIGNIFIQUEN LO CONTRARIO / OPUESTO',
        pares: [
          { word1: 'ALTO', word2: 'BAJO' },
          { word1: 'DESPIERTO', word2: 'DORMIDO' },
          { word1: 'CONTENTO', word2: 'TRISTE' },
          { word1: 'RAPIDO', word2: 'LENTO' }
        ]
      }
    ];

    let currentSet = 0;
    let selectedWord = null;
    let connections = [];
    let correctPairs = 0;
    let desaciertos = 0;
    const id_paciente = localStorage.getItem('id_paciente');

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function loadGame() {
      const wordsContainer = document.getElementById('wordsContainer');
      const instructionsBox = document.querySelector('.instructions h2');
      instructionsBox.textContent = sets[currentSet].instrucciones;
      const leftColumn = document.createElement('div');
      const rightColumn = document.createElement('div');
      leftColumn.className = 'column';
      rightColumn.className = 'column';

      // Separar las palabras en dos columnas
      const leftWords = sets[currentSet].pares.map(pair => pair.word1);
      const rightWords = sets[currentSet].pares.map(pair => pair.word2);

      // Mezclar cada columna por separado
      const shuffledLeftWords = shuffleArray([...leftWords]);
      const shuffledRightWords = shuffleArray([...rightWords]);

      // Crear las cajas de palabras para cada columna
      leftColumn.innerHTML = shuffledLeftWords.map(word => `
        <div class="word-box" data-word="${word}" data-side="left">
          ${word}
        </div>
      `).join('');

      rightColumn.innerHTML = shuffledRightWords.map(word => `
        <div class="word-box" data-word="${word}" data-side="right">
          ${word}
        </div>
      `).join('');

      wordsContainer.innerHTML = '';
      wordsContainer.appendChild(leftColumn);
      wordsContainer.appendChild(rightColumn);

      setupWordBoxes();
    }

    function createConnection(left, right) {
      // Eliminar cualquier flecha existente entre estas palabras
      document.querySelectorAll('.connection-line, .connection-arrow').forEach(el => el.remove());
      
      const line = document.createElement('div');
      line.className = 'connection-line';
      
      const arrow = document.createElement('div');
      arrow.className = 'connection-arrow';
      
      const container = document.querySelector('.words-container');
      container.appendChild(line);
      container.appendChild(arrow);
      
      updateConnection(left, right, line, arrow);
    }

    function updateConnection(left, right, line, arrow) {
      const leftRect = left.getBoundingClientRect();
      const rightRect = right.getBoundingClientRect();
      const containerRect = document.querySelector('.words-container').getBoundingClientRect();
      
      const startX = leftRect.right - containerRect.left;
      const startY = leftRect.top + leftRect.height/2 - containerRect.top;
      const endX = rightRect.left - containerRect.left;
      const endY = rightRect.top + rightRect.height/2 - containerRect.top;
      
      const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
      const angle = Math.atan2(endY - startY, endX - startX);
      
      line.style.width = `${length}px`;
      line.style.left = `${startX}px`;
      line.style.top = `${startY}px`;
      line.style.transform = `rotate(${angle}rad)`;
      
      arrow.style.left = `${endX - 10}px`;
      arrow.style.top = `${endY - 8}px`;
      arrow.style.transform = `rotate(${angle}rad)`;
    }

    function setupWordBoxes() {
      const wordBoxes = document.querySelectorAll('.word-box');
      wordBoxes.forEach(box => {
        box.addEventListener('click', () => {
          if (connections.some(conn => conn.left === box || conn.right === box)) return;

          // Quitar selecci√≥n previa
          wordBoxes.forEach(b => b.classList.remove('selected'));

          if (!selectedWord) {
            selectedWord = box;
            box.classList.add('selected');
          } else {
            if (selectedWord.dataset.side === box.dataset.side) {
              selectedWord = box;
              box.classList.add('selected');
              return;
            }
            if (connections.some(conn => conn.left === selectedWord || conn.right === selectedWord || conn.left === box || conn.right === box)) {
              selectedWord = null;
              return;
            }
            let left, right;
            if (selectedWord.dataset.side === 'left') {
              left = selectedWord;
              right = box;
            } else {
              left = box;
              right = selectedWord;
            }
            const isCorrect = sets[currentSet].pares.some(pair => pair.word1 === left.dataset.word && pair.word2 === right.dataset.word);
            if (isCorrect) {
              connections.push({ left, right });
              left.classList.remove('selected');
              right.classList.remove('selected');
              left.classList.add('connected');
              right.classList.add('connected');
              createConnection(left, right);
              Swal.fire({
                title: 'üéâ',
                icon: 'none',
                timer: 1500,
                showConfirmButton: false,
                customClass: {
                  title: 'emoji-title',
                  popup: 'emoji-popup'
                }
              });
              correctPairs++;
              if (correctPairs === sets[currentSet].pares.length) {
                if (currentSet < sets.length - 1) {
                  setTimeout(() => {
                    currentSet++;
                    selectedWord = null;
                    connections = [];
                    correctPairs = 0;
                    desaciertos = 0;
                    document.querySelectorAll('.word-box').forEach(box => box.classList.remove('connected'));
                    document.querySelectorAll('.connection-line, .connection-arrow').forEach(el => el.remove());
                    loadGame();
                  }, 1500);
                } else {
                  setTimeout(() => {
                    enviarResultados();
                    window.location.href = 'semantica3.html';
                  }, 1500);
                }
              }
            } else {
              desaciertos++;
              Swal.fire({
                title: 'üò¢',
                icon: 'none',
                timer: 1500,
                showConfirmButton: false,
                customClass: {
                  title: 'emoji-title',
                  popup: 'emoji-popup'
                }
              });
            }
            // Quitar selecci√≥n despu√©s de intentar unir
            wordBoxes.forEach(b => b.classList.remove('selected'));
            selectedWord = null;
          }
        });
      });
    }

    function enviarResultados() {
      if (!id_paciente) {
        console.error('No hay id_paciente en localStorage');
        return;
      }
      const data = {
        id_paciente: parseInt(id_paciente),
        paciente_juego: 'Semantica-Nivel 2',
        paciente_resultado: `aciertos: ${correctPairs}, desaciertos: ${desaciertos}`,
        paciente_acierto: correctPairs,
        paciente_desacierto: desaciertos
      };

      fetch('http://localhost:3000/juegos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (!res.ok) throw new Error('Error al enviar resultados');
        return res.text();
      })
      .then(msg => console.log(msg))
      .catch(err => console.error(err));
    }

    // Iniciar el juego
    loadGame();

    const avatar = sessionStorage.getItem('selectedAvatar');
    const avatarImg = document.getElementById('selected-avatar');
    if (avatar) {
      avatarImg.src = avatar;
      avatarImg.style.display = 'block';
    } else {
      window.location.href = '../../avatar.html';
    }
    const volverBtn = document.getElementById('volver-btn');
    volverBtn.onclick = () => window.location.href = '../../index.html';

    // Panel lateral
    const avatarPanel = document.getElementById('avatar-panel');
    const avatarPanelImg = document.getElementById('avatar-panel-img');
    const panelNombre = document.getElementById('panel-nombre');
    const panelEdad = document.getElementById('panel-edad');
    const soundBtn = document.getElementById('sound-btn');
    const soundIcon = document.getElementById('sound-icon');
    const soundText = document.getElementById('sound-text');
    const closePanel = document.getElementById('close-panel');
    avatarImg.onclick = function() {
      avatarPanel.style.display = 'block';
      setTimeout(()=>{avatarPanel.style.transform = 'translateX(0)';},10);
      avatarPanelImg.src = avatarImg.src;
      // SIEMPRE EN MAY√öSCULAS
      let nombre = (localStorage.getItem('nombre_nino') || 'Sin nombre').toUpperCase();
      let edad = (localStorage.getItem('edad_nino') || 'Sin edad').toUpperCase();
      panelNombre.textContent = nombre;
      panelEdad.textContent = edad;
      let sonido = sessionStorage.getItem('sonido_activado');
      if(sonido === null) sonido = 'true';
      if(sonido === 'true') {
        soundIcon.textContent = 'üîä';
        soundText.textContent = 'SONIDO ACTIVADO';
        soundBtn.style.background = '#ffd817';
        soundBtn.style.color = '#333';
      } else {
        soundIcon.textContent = 'üîá';
        soundText.textContent = 'SONIDO DESACTIVADO';
        soundBtn.style.background = '#eee';
        soundBtn.style.color = '#888';
      }
    };
    closePanel.onclick = function() {
      avatarPanel.style.transform = 'translateX(-100%)';
      setTimeout(()=>{avatarPanel.style.display = 'none';},300);
    };
    soundBtn.onclick = function() {
      let sonido = sessionStorage.getItem('sonido_activado');
      if(sonido === null) sonido = 'true';
      if(sonido === 'true') {
        sessionStorage.setItem('sonido_activado','false');
        if(window.globalAudio){window.globalAudio.pause();}
        soundIcon.textContent = 'üîá';
        soundText.textContent = 'SONIDO DESACTIVADO';
        soundBtn.style.background = '#eee';
        soundBtn.style.color = '#888';
      } else {
        sessionStorage.setItem('sonido_activado','true');
        if(window.globalAudio){window.globalAudio.play();}
        soundIcon.textContent = 'üîä';
        soundText.textContent = 'SONIDO ACTIVADO';
        soundBtn.style.background = '#ffd817';
        soundBtn.style.color = '#333';
      }
    };
    window.addEventListener('click', function(e) {
      if(avatarPanel.style.display==='block' && !avatarPanel.contains(e.target) && e.target!==avatarImg) {
        avatarPanel.style.transform = 'translateX(-100%)';
        setTimeout(()=>{avatarPanel.style.display = 'none';},300);
      }
    });
    loadRound();
  </script>
</body>
</html>
